<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container my-5">
        <h2 class="mb-4">Checkout</h2>

        <div id="order-summary" class="mb-4"></div>

        <form id="checkout-form">
            <div class="mb-3">
                <label class="form-label">Full Name</label>
                <input type="text" id="fullName" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="email" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Shipping Address</label>
                <textarea id="address" class="form-control" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Place Order</button>
        </form>
    </div>

    <script>
        let ecommerceData = JSON.parse(localStorage.getItem("ecommerceData")) || {};
        let loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        let userCart = ecommerceData.cart?.find(c => c.userId == loggedInUser.id);

        function loadSummary() {
            let data = userCart ? userCart.items : [];
            let summaryHTML = "<h4>Order Summary</h4><ul class='list-group'>";
            let total = 0;

            data.forEach(item => {
                let product = ecommerceData.products.find(p => p.id == item.productId);
                let price = product.discount ? product.price - product.price * (product.discount / 100) : product.price;
                total += price * item.quantity;
                summaryHTML += `<li class="list-group-item d-flex justify-content-between">
          ${product.name} x ${item.quantity}
          <span>$${(price * item.quantity).toFixed(2)}</span>
        </li>`;
            });

            summaryHTML += `</ul><h5 class="mt-3">Total: $${total.toFixed(2)}</h5>`;

            if (data.length === 0) {
                summaryHTML = "<p>Your cart is empty.</p>";
            }

            document.getElementById("order-summary").innerHTML = summaryHTML;
        }

        function createOrder() {
            if (!userCart || userCart.items.length === 0) return null;

            let totalAmount = 0;
            let items = userCart.items.map(item => {
                let product = ecommerceData.products.find(p => p.id == item.productId);
                let price = product.discount ? product.price - product.price * (product.discount / 100) : product.price;
                totalAmount += price * item.quantity;
                return { ...item, price };
            });

            const order = {
                orderId: Date.now(),
                userId: loggedInUser.id,
                status: "Pending",
                items,
                totalAmount,
                fullName: document.getElementById("fullName").value,
                email: document.getElementById("email").value,
                address: document.getElementById("address").value,
                orderDate: new Date().toISOString()
            };

            // Add to orders
            if (!ecommerceData.orders) ecommerceData.orders = [];
            ecommerceData.orders.push(order);

            // Clear the user's cart
            userCart.items = [];

            // Save back to localStorage
            localStorage.setItem("ecommerceData", JSON.stringify(ecommerceData));

            return order;
        }

        document.getElementById("checkout-form").addEventListener("submit", function (e) {
            e.preventDefault();

            const order = createOrder();
            if (!order) {
                alert("Your cart is empty. Cannot place order.");
                return;
            }

            alert("Order placed successfully!");
            window.location.href = "cart.html";
        });

        loadSummary();
    </script>
</body>

</html>